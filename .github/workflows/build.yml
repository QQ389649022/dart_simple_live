name: Build and Release

on:
  workflow_dispatch: # 方便手动触发

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # 我们先集中精力修好 Windows 端的编译
          - os: windows-latest
            build_cmd: flutter build windows --release
            artifact_path: simple_live_app/build/windows/runner/Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive # 必须递归拉取，否则核心库可能缺失

      # 解决 Windows 路径过长导致的编译失败
      - name: Enable long paths
        run: git config --global core.longpaths true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.24.0' # 强制指定一个较新的稳定版本

      - name: Install dependencies
        working-directory: ./simple_live_app
        run: flutter pub get

      - name: Build Project
        working-directory: ./simple_live_app
        run: ${{ matrix.build_cmd }}

      - name: Package Windows Release
        if: matrix.os == 'windows-latest'
        run: |
          Compress-Archive -Path "${{ github.workspace }}/${{ matrix.artifact_path }}/*" -DestinationPath "${{ github.workspace }}/simple_live_windows.zip"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: simple_live_windows.zip
